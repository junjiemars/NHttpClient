apply plugin: 'java'
apply plugin: 'war'
//apply plugin: 'jetty'
apply plugin: 'com.bmuschko.cargo'

sourceCompatibility = 1.6
version = '1.0'

//retrieve cargo plugin
buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'com.bmuschko:gradle-cargo-plugin:2.1'
    }
}

////configure cargo plugin for jetty8x
//cargo {
//      jetty8x will return 500 for timeout
//    containerId = 'jetty8x'
//    port = http_port(8080);
//
//    deployable {
//        file = file('build/libs/NHttpWeb-1.0.war')
//        context = '/'
//    }
//
////    remote {
////        hostname = 'localhost'
////        username = 'junjie'
////        password = ''
////    }
//
//    local {
//        installer {
//            installUrl = 'http://mirrors.yun-idc.com/eclipse/jetty/stable-8/dist/jetty-distribution-8.1.16.v20140903.tar.gz'
//            downloadDir = file("$buildDir/download")
//            extractDir = file("$buildDir/extract")
//            jvmArgs = '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'
//        }
////        homeDir = file('/opt/jetty/v8116')
////        outputFile = file('build/output.log')
////        timeout = 60000
//    }
//}

//configure cargo plugin for tomcat7x
cargo {
    containerId = 'tomcat7x'
    port = http_port(8080);

    deployable {
        file = file('build/libs/NHttpWeb-1.0.war')
        context = '/'
    }

    local {
        installer {
            installUrl = 'http://apache.osuosl.org/tomcat/tomcat-7/v7.0.61/bin/apache-tomcat-7.0.61.zip'
            downloadDir = file("$buildDir/download")
            extractDir = file("$buildDir/extract")
            jvmArgs = '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'
        }
    }
}

//jettyRun.webAppSourceDirectory = file("src/main/java")
//httpPort=8080
//stopPort=8090

repositories {
    mavenCentral()
    mavenLocal()
    maven {
        // netty.io maven repo
        url "http://clinker.netty.io/nexus/content/repositories/snapshots"
    }
}

dependencies {
    testCompile group: 'junit', name: 'junit', version: '4.11'
    //compile 'javax.servlet:servlet-api:2.5'
    //compile fileTree(dir: '/opt/jetty/v8116/lib/', include: 'servlet-api-3.0.jar')
    compile 'javax.servlet:javax.servlet-api:3.1.0'
    compile project(':NHttpClient')
    compile 'org.apache.logging.log4j:log4j-api:2.1'
    compile 'org.apache.logging.log4j:log4j-core:2.1'
    compile 'org.apache.logging.log4j:log4j-web:2.1'
}

war {
    from('src/main/java/WEB-INF') {
        include 'index.html'
    }
    webXml = file('src/main/java/WEB-INF/web.xml')
}

int http_port(port) {
    def p = System.getProperty("http.port");
    p ? p.toInteger() : port
}

